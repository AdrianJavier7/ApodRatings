{% extends 'base.html.twig' %}

{% block title %}{{ foto_astral.title }}{% endblock %}

{% block body %}
    <div class="uk-section uk-light" style="background: #0b0d17; min-height: 100vh;">
        <div class="uk-container uk-container-small">

            {# 1. ENCABEZADO #}
            <div class="uk-text-center uk-margin-large-bottom">
                <h1 class="uk-heading-small uk-text-bold uk-margin-remove-top">{{ foto_astral.title }}</h1>
                <p class="uk-text-meta uk-text-large">
                    <span uk-icon="calendar"></span> {{ foto_astral.date|date('d/m/Y') }}
                </p>
            </div>

            {# 2. IMAGEN PRINCIPAL #}
            <div class="uk-margin-large-bottom">
                <div class="uk-inline uk-width-1-1 uk-box-shadow-xlarge" style="border-radius: 20px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);">
                    <img src="{{ foto_astral.url }}" class="uk-width-1-1" alt="{{ foto_astral.title }}" style="max-height: 500px; object-fit: cover;">
                    <div class="uk-position-bottom-right uk-overlay uk-overlay-default uk-padding-small" style="background: rgba(0,0,0,0.6); border-top-left-radius: 10px;">
                        <a href="{{ foto_astral.url }}" target="_blank" class="uk-button uk-button-text uk-text-small">
                            <span uk-icon="expand"></span> Pantalla Completa
                        </a>
                    </div>
                </div>
            </div>

            {# 3. EXPLICACIÓN #}
            <div class="uk-grid-large" uk-grid>
                <div class="uk-width-1-1">
                    <div class="uk-panel uk-margin-large-bottom">
                        <p class="uk-text-justify uk-dropcap" style="font-size: 1.15rem; line-height: 1.8; color: #d1d1d1;">
                            {{ foto_astral.explanation }}
                        </p>
                    </div>

                    <hr class="uk-divider-icon uk-margin-large">

                    {# 4. SECCIÓN DE RESEÑAS #}
                    <div class="uk-flex uk-flex-between uk-flex-middle uk-margin-large-bottom">
                        <h2 class="uk-text-bold uk-margin-remove">Exploradores</h2>

                        {# Cambia tu bloque de botón por este #}
                        {% if not ya_valorado %}
                            {% if app.user %}
                                {# Usuario logueado: va a escribir la reseña #}
                                <a href="{{ path('app_review', {fecha: foto_astral.date|date('Y-m-d')}) }}"
                                   class="uk-button uk-button-default uk-border-rounded"
                                   style="background: white; border: none; padding: 0 30px; color: black;">
                                    <span uk-icon="file-edit" class="uk-margin-small-right"></span> Escribir Reseña
                                </a>
                            {% else %}
                                <a href="{{ path('app_login') }}"
                                   class="uk-button uk-button-default uk-border-rounded"
                                   style="background: rgba(255,255,255,0.1); border: 1px solid white; padding: 0 30px; color: white;">
                                    <span uk-icon="sign-in" class="uk-margin-small-right"></span> Logueate para reseñar
                                </a>
                            {% endif %}
                        {% endif %}
                    </div>

                    <div class="uk-grid-medium uk-child-width-1-1" uk-grid>
                        {% for resena in resenas %}
                            <div class="uk-card uk-card-body uk-border-rounded uk-margin-small-bottom"
                                 style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05);">

                                <div class="uk-flex uk-flex-between uk-flex-middle">
                                    <div class="uk-flex uk-flex-middle">
                                        <div class="uk-margin-small-right">
                                            <div style="width: 35px; height: 35px; background: #1a1a2e; border: 1px solid #1e87f0; border-radius: 50%; display: flex; align-items: center; justify-content: center;" class="uk-text-bold uk-text-primary">
                                                {{ resena.usuario.userIdentifier|slice(0,1)|upper }}
                                            </div>
                                        </div>
                                        <span class="uk-text-bold">@{{ resena.usuario.userIdentifier }}</span>

                                        {% if app.user and resena.usuario.id == app.user.id %}
                                            <span class="uk-label uk-label-info uk-margin-small-left" style="font-size: 0.6rem;">TU RESEÑA</span>
                                        {% endif %}
                                    </div>

                                    <div class="uk-flex uk-flex-middle">
                                        <div class="uk-margin-right">
                                            {% set nota = resena.estrellas|default(0)|abs %}
                                            {% for i in 1..5 %}
                                                <span uk-icon="icon: star; ratio: 0.8"
                                                      style="color: {{ i <= nota ? '#f8ce0b' : '#444' }} !important;">
                                                 </span>
                                            {% endfor %}
                                        </div>

                                        {% if app.user and resena.usuario.id == app.user.id %}
                                            <a href="#modal-editar-{{ resena.id }}" uk-toggle class="uk-icon-button" uk-icon="pencil"
                                               style="background: rgba(30, 135, 240, 0.1); color: #1e87f0;" title="Editar mi reseña"></a>
                                        {% endif %}
                                    </div>
                                </div>

                                <p class="uk-margin-medium-top uk-text-muted uk-text-italic" style="border-left: 2px solid #1e87f0; padding-left: 15px;">
                                    "{{ resena.comentario }}"
                                </p>
                            </div>

                            {# MODAL DE EDICIÓN PARA ESTA RESEÑA #}
                            {% if app.user and resena.usuario.id == app.user.id %}
                                <div id="modal-editar-{{ resena.id }}" uk-modal>
                                    <div class="uk-modal-dialog uk-modal-body uk-background-secondary uk-light uk-border-rounded" style="border: 1px solid rgba(30, 135, 240, 0.3);">
                                        <button class="uk-modal-close-default" type="button" uk-close></button>
                                        <h2 class="uk-modal-title uk-text-bold">Editar Bitácora</h2>

                                        <form method="POST" action="{{ path('app_review_editar', {id: resena.id}) }}" class="uk-form-stacked">

                                            <div class="uk-margin">
                                                <label class="uk-form-label uk-text-bold">Puntuación Estelar</label>
                                                <div class="uk-form-controls uk-margin-small-top">
                                                    <input class="uk-range" type="range" name="estrellas" value="{{ resena.estrellas }}" min="0" max="5" step="0.5"
                                                           style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 5px;">
                                                    <div class="uk-flex uk-flex-between uk-text-meta uk-margin-small-top">
                                                        <span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="uk-margin">
                                                <label class="uk-form-label uk-text-bold">Comentario</label>
                                                <div class="uk-form-controls">
                                                    <textarea class="uk-textarea uk-border-rounded" name="comentario" rows="5"
                                                              style="background: rgba(0,0,0,0.3); color: #fff; border-color: rgba(255,255,255,0.1);"
                                                              required>{{ resena.comentario }}</textarea>
                                                </div>
                                            </div>

                                            <div class="uk-text-right uk-margin-top">
                                                <button class="uk-button uk-button-default uk-modal-close uk-border-rounded" type="button">Cancelar</button>
                                                <button class="uk-button uk-button-primary uk-border-rounded uk-text-bold" type="submit">Actualizar Reseña</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            {% endif %}

                        {% else %}
                            <div class="uk-text-center uk-padding-large">
                                <p class="uk-text-muted">Aún no hay valoraciones para esta imagen.</p>
                            </div>
                        {% endfor %}
                    </div>

                </div>
            </div>

            {# 5. BOTÓN VOLVER #}
            <div class="uk-text-center uk-margin-xlarge-top">
                <a href="javascript:history.back()" class="uk-button uk-button-text">
                    <span uk-icon="arrow-left"></span> Volver a la exploración
                </a>
            </div>

        </div>
    </div>
{% endblock %}
